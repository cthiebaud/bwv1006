%%{init: {'theme':'neutral'}}%%
graph TD
    %% Input Sources
    A[bwv1006.ly<br/>📄 Main Score] --> B[build_pdf]
    A --> C[build_svg]
    
    A1[bwv1006_ly_one_line.ly<br/>📄 One-line Score] --> D[build_svg_one_line]
    
    A2[🔧 Shared Dependencies<br/>• bwv1006_ly_main.ly<br/>• highlight-bars.ily<br/>• defs.ily<br/>• _?/*.ly files] --> B
    A2 --> C
    A2 --> D
    
    %% PDF Generation
    B --> B1[bwv1006.pdf<br/>📑 PDF Output]
    
    %% SVG Generation Chain
    C --> C1[bwv1006.svg<br/>🎼 Main SVG Score]
    C1 --> E[postprocess_svg]
    
    %% SVG Post-processing Pipeline
    E --> E1[svg_remove_hrefs_in_tabs.py<br/>🔗 Remove tab links]
    E1 --> E2[bwv1006_svg_no_hrefs_in_tabs.svg]
    
    E2 --> E3[svg_tighten_viewbox.py<br/>📐 Optimize viewBox]
    E3 --> E4[bwv1006_svg_no_hrefs_in_tabs_bounded.svg]
    
    E4 --> E5[svg_optimize.py<br/>⚡ SVGO optimization]
    E5 --> E6[bwv1006_svg_no_hrefs_in_tabs_bounded_optimized.svg]
    
    E6 --> E7[svg_prepare_for_swell.py<br/>🎯 Animation prep]
    E7 --> E8[bwv1006_svg_no_hrefs_in_tabs_bounded_optimized_swellable.svg<br/>🎨 Final animated SVG]
    
    %% One-line SVG and MIDI Generation
    D --> D1[bwv1006_ly_one_line.svg<br/>🎼 One-line SVG]
    D --> D2[bwv1006_ly_one_line.midi<br/>🎵 MIDI Data]
    
    %% JSON Notes Pipeline
    D1 --> F[json_notes]
    D2 --> F
    
    F --> F1[midi_map.py<br/>⏱️ Extract MIDI timing]
    F1 --> F2[bwv1006_csv_midi_note_events.csv<br/>📊 MIDI Events]
    
    F --> F3[svg_extract_note_heads.py<br/>📍 Extract notehead positions]
    F3 --> F4[bwv1006_csv_svg_note_heads.csv<br/>📊 SVG Noteheads]
    
    F2 --> F5[align_pitch_by_geometry_simplified.py<br/>🎯 Align MIDI↔SVG]
    F4 --> F5
    F5 --> F6[bwv1006_json_notes.json<br/>🎵 Synchronized Data]
    
    %% Master Task
    G[all] --> B
    G --> C
    G --> E
    G --> D
    G --> F
    
    %% Styling
    classDef inputFile fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef task fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef outputFile fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef script fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef finalOutput fill:#ffebee,stroke:#b71c1c,stroke-width:3px
    
    class A,A1,A2 inputFile
    class B,C,D,E,F,G task
    class B1,C1,D1,D2,E2,E4,E6,F2,F4 outputFile
    class E1,E3,E5,E7,F1,F3,F5 script
    class E8,F6 finalOutput
    
    