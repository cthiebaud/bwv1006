<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>BWV 1006</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
  <style>
    svg a path {
      transition: fill 0.3s ease, filter 1s ease;
      fill: black;
    }

    a.active.channel-0 path {
      fill: #fc8d59 !important;
      filter: drop-shadow(0 0 5px #fc8d59) drop-shadow(0 0 10px #fc8d59);
    }

    a.active.channel-1 path {
      fill: #91cf60 !important;
      filter: drop-shadow(0 0 5px #91cf60) drop-shadow(0 0 10px #91cf60);
    }

    a.active.channel-2 path {
      fill: #d73027 !important;
      filter: drop-shadow(0 0 5px #d73027) drop-shadow(0 0 10px #d73027);
    }

    a.active.channel-3 path {
      fill: #fee08b !important;
      filter: drop-shadow(0 0 5px #fee08b) drop-shadow(0 0 10px #fee08b);
    }

    a.active.channel-4 path {
      fill: #d9ef8b !important;
      filter: drop-shadow(0 0 5px #d9ef8b) drop-shadow(0 0 10px #d9ef8b);
    }

    a.active.channel-5 path {
      fill: #1a9850 !important;
      filter: drop-shadow(0 0 5px #1a9850) drop-shadow(0 0 10px #1a9850);
    }

    a.active.channel-6 path {
      fill: #4575b4 !important;
      filter: drop-shadow(0 0 5px #4575b4) drop-shadow(0 0 10px #4575b4);
    }

    a.active.channel-7 path {
      fill: #74add1 !important;
      filter: drop-shadow(0 0 5px #74add1) drop-shadow(0 0 10px #74add1);
    }

    #svg-container {
      display: grid;
      place-items: start center; /* align top, center horizontally */
      position: relative;
    }

    /* Bar highlight styles */
    .bar-highlight {
      fill: rgba(135, 206, 250, 0.25); /* Light blue with 25% opacity */
      stroke: rgba(30, 144, 255, 0.5); /* Darker blue stroke with 50% opacity */
      stroke-width: 1px;
      pointer-events: none; /* Allow clicks to pass through to elements beneath */
      transition: opacity 0.3s ease;
    }

    /* Animation for bar highlight fade in/out */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .bar-highlight.active {
      animation: fadeIn 0.3s ease forwards;
    }
  </style>
</head>

<body>
  <div class="sticky-top bg-light py-2 shadow-sm border-bottom">
    <div class="container-fluid text-center">
      <h2>BWV 1006</h2>
      <audio id="audio" controls src="wavs/bwv1006202505211530.wav"></audio>
    </div>
  </div>
  <div id="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div>Loading score and notesâ€¦</div>
  </div>
  <!-- Centered SVG container -->
  <div class="container-fluid">
    <div id="svg-container" class="" style="display: grid;"></div>
  </div>

  <script>
    const svgPath = "bwv1006_svg_no_hrefs_in_tabs_bounded.svg";
    const notesPath = "bwv1006_json_notes.json";
    const audio = document.getElementById("audio");

    let notes = [], remainingNotes = [], offCandidateNotes = [];
    let svgGlobal, noteDataGlobal;
    let isPlaying = false;
    let barToNotesMap = {}; // Maps bar numbers to notes in that bar
    let currentBarElement = null; // Currently highlighted bar
    
    // Information about bar boundaries
    let barElements = [];
    let barBoundaries = {};
    
    function initializeNotes() {
      notes = noteDataGlobal.map(n => {
        const elements = n.hrefs.map(href => {
          const selector = `[*|href$="${href}"], [href$="${href}"]`;
          return svgGlobal.querySelector(selector);
        }).filter(Boolean);

        // Add CSS class based on MIDI channel
        elements.forEach(el => {
          el.classList.add(`channel-${n.channel}`);
        });

        return {
          on: n.on,
          off: n.off,
          elements,
        };
      });

      remainingNotes = [...notes];
      offCandidateNotes = [];
    }

    function initializeBarElements() {
      // Get all bar elements from the SVG
      const barGroups = Array.from(svgGlobal.querySelectorAll('g[data-bar]'));
      
      if (barGroups.length === 0) {
        console.warn("No bar elements found with data-bar attribute");
        return;
      }
      
      console.log(`Found ${barGroups.length} bar elements`);
      
      // Create a namespace for SVG elements
      const svgNS = "http://www.w3.org/2000/svg";
      
      // Create a group for all bar highlights
      const highlightGroup = document.createElementNS(svgNS, "g");
      highlightGroup.setAttribute("id", "bar-highlights");
      
      // Insert the highlight group at the beginning of the SVG to ensure it's behind other elements
      svgGlobal.insertBefore(highlightGroup, svgGlobal.firstChild);
      
      // Calculate bar boundaries and create highlight rectangles
      barGroups.forEach(barGroup => {
        const barNumber = barGroup.getAttribute('data-bar');
        
        barGroup.style.color = 'red'
        
        // Get the bounding box of the bar group
        const bbox = barGroup.getBBox();
        
        // Store bar boundary information
        barBoundaries[barNumber] = {
          x: bbox.x,
          y: bbox.y,
          width: bbox.width,
          height: bbox.height,
          element: barGroup
        };
        
        // Create a highlight rectangle for this bar
        const highlight = document.createElementNS(svgNS, "rect");
        highlight.setAttribute("class", "bar-highlight");
        highlight.setAttribute("x", bbox.x - 5); // Slightly wider than the bar
        highlight.setAttribute("y", bbox.y - 5); // Slightly lefter than the bar
        highlight.setAttribute("width", bbox.width + 10); // Slightly wider than the bar
        highlight.setAttribute("height", bbox.height + 10); // Slightly higher than the bar
        highlight.setAttribute("data-bar", barNumber);
        highlight.style.opacity = 0; // Hidden by default
        
        // Add the highlight rectangle to the group
        highlightGroup.appendChild(highlight);
        
        barElements.push({
          barNumber: parseInt(barNumber),
          element: barGroup,
          highlight: highlight
        });
      });
      
      // Sort bar elements by bar number
      barElements.sort((a, b) => a.barNumber - b.barNumber);
      
      console.log(`Created highlight rectangles for ${barElements.length} bars`);
    }

    function findBarForTime(time) {
      // This is a placeholder function - you'll need to implement logic
      // to determine which bar corresponds to a given time position
      // For example, by mapping time ranges to bar numbers
      
      // Simple approximation: assume each bar is around 2-4 seconds
      // This is just an example - you'll need to adjust based on your music
      const estimatedBarNumber = Math.floor(time ) + 1;
      
      // Find the bar element with this number or the closest one
      const exactBar = barElements.find(b => b.barNumber === estimatedBarNumber);
      if (exactBar) {
        return exactBar;
      }
      
      // If no exact match, find the closest bar
      return barElements.reduce((closest, current) => {
        if (!closest) return current;
        if (Math.abs(current.barNumber - estimatedBarNumber) < 
            Math.abs(closest.barNumber - estimatedBarNumber)) {
          return current;
        }
        return closest;
      }, null);
    }

    function highlightBar(barElement) {
      if (currentBarElement) {
        // Remove highlight from the previous bar
        currentBarElement.highlight.style.opacity = 0;
        currentBarElement.highlight.classList.remove('active');
      }
      
      if (barElement) {
        // Add highlight to the new bar
        barElement.highlight.style.opacity = 1;
        barElement.highlight.classList.add('active');
        
        // Scroll the bar into view if needed
        const rect = barElement.element.getBoundingClientRect();
        if (rect.top < 0 || rect.bottom > window.innerHeight) {
          barElement.element.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }
        
        currentBarElement = barElement;
      } else {
        currentBarElement = null;
      }
    }

    function highlightNote(note) {
      note.elements.forEach(el => el.classList.add("active"));
    }

    function unhighlightNote(note) {
      note.elements.forEach(el => el.classList.remove("active"));
    }

    function syncLoop() {
      if (!isPlaying) return; // Don't proceed if audio is paused or ended

      const now = audio.currentTime;
      
      // Find and highlight the current bar
      const currentBar = findBarForTime(now);
      if (currentBar && (!currentBarElement || currentBar.barNumber !== currentBarElement.barNumber)) {
        highlightBar(currentBar);
      }
      
      while (remainingNotes.length && remainingNotes[0].on <= now + 0.2) {
        const note = remainingNotes.shift();
        highlightNote(note);
        offCandidateNotes.push(note);
      }

      offCandidateNotes = offCandidateNotes.filter(note => {
        if (note.off <= now) {
          unhighlightNote(note);
          return false;
        }
        return true;
      });

      requestAnimationFrame(syncLoop);
    }

    function resetAnimationState() {
      isPlaying = false;
      audio.currentTime = 0;
      initializeNotes();
      svgGlobal?.querySelectorAll("a.active").forEach(el => el.classList.remove("active"));
      highlightBar(null); // Remove bar highlight
    }

    async function setup() {
      try {
        const [svgText, noteData] = await Promise.all([
          fetch(svgPath).then(r => {
            if (!r.ok) throw new Error("Failed to load SVG");
            return r.text();
          }),
          fetch(notesPath).then(r => {
            if (!r.ok) throw new Error("Failed to load bwv1006_json_notes.json");
            return r.json();
          })
        ]);

        noteDataGlobal = noteData;

        const svgContainer = document.getElementById("svg-container");
        svgContainer.innerHTML = svgText;
        svgGlobal = svgContainer.querySelector("svg");

        if (!svgGlobal) {
          console.error("SVG element not found in loaded content");
          return;
        }

        initializeNotes();
        initializeBarElements(); // Initialize bar highlights
        initEventHandlers();

        console.log(`Loaded ${notes.length} notes`);
      } catch (err) {
        console.error("Setup error:", err);
      }
      document.getElementById("loading")?.classList.add("d-none");
    }

    if (audio.readyState >= 1) {
      setup();
    } else {
      audio.addEventListener("loadedmetadata", setup);
    }

    function initEventHandlers() {
      audio.addEventListener("play", () => {
        isPlaying = true;
        requestAnimationFrame(syncLoop);
        console.log("Playback started.");
      });

      audio.addEventListener("seeked", () => {
        console.log("seeked");
        const now = audio.currentTime;

        remainingNotes = notes.filter(note => note.on > now);
        offCandidateNotes = notes.filter(note => note.on <= now && note.off > now);

        svgGlobal?.querySelectorAll("a.active").forEach(el => el.classList.remove("active"));
        offCandidateNotes.forEach(note => highlightNote(note));
        
        // Update bar highlight when seeking
        const currentBar = findBarForTime(now);
        if (currentBar) {
          highlightBar(currentBar);
        }
        
        console.log("seeked to", now.toFixed(3), "â†’ notes updated");
      });

      audio.addEventListener("pause", () => {
        isPlaying = false;
        console.log("Playback paused.");
      });

      audio.addEventListener("ended", () => {
        resetAnimationState();
        console.log("Playback ended.");
      });
    }
  </script>
</body>

</html>