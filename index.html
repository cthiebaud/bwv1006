<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="media/bach-seal.svg">
  <meta name="theme-color" content="#8B4513">
  <title>BWV 1006</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
  <style>
    :root {
      --header-height: 120px;
      /* Centralized header height - used by scroll positioning and CSS scroll-margin */
    }

    /* SVG container positioning and scroll behavior */
    #svg-container {
      display: grid;
      place-items: start center;
      scroll-margin-top: var(--header-height);
      /* Accounts for sticky header when scrolling */
    }

    #svg-container svg {
      height: auto;
      max-width: 100%;
    }

    /* Note highlighting transitions - slow fade out for smooth visual */
    #svg-container svg a[href] path {
      transition: fill 1.25s ease, filter 1.25s ease, transform 1.25s ease;
    }

    /* Fast fade in for immediate visual feedback */
    #svg-container svg a[href].active path {
      transition: fill 0.15s linear, filter 0.15s linear, transform 0.15s linear;
    }

    /* Scale effect for active notes */
    #svg-container svg a[href].active {
      transform-box: fill-box;
      transform-origin: center;
      transform: scale(1.25);
    }

    /* Bar highlights only visible during playback */
    #svg-container svg:not(.playing) rect[data-bar] {
      visibility: hidden !important;
    }

    /* Channel-specific colors for different instrument parts */
    #svg-container svg.playing a[href].active.channel-0 path {
      fill: coral !important;
      filter: drop-shadow(0 0 5px coral) drop-shadow(0 0 10px coral);
    }

    #svg-container svg.playing a[href].active.channel-1 path {
      fill: lightgreen !important;
      filter: drop-shadow(0 0 5px lightgreen) drop-shadow(0 0 10px lightgreen);
    }

    /* Hide scroll-to-top button when playing or already at optimal position */
    .playing #button_scroll_to_top,
    .svg-at-top #button_scroll_to_top {
      visibility: hidden !important;
    }
  </style>
</head>

<body>
  <!-- Sticky header with audio controls and navigation buttons -->
  <div class="sticky-top bg-light py-2 shadow-sm border-bottom">
    <div id="header" class="svg-at-top container-fluid text-center">
      <h2 class="d-flex align-items-center justify-content-center position-relative">
        <span>Preludio BWV 1006</span>
        <!-- Wikipedia link button - positioned dynamically by JavaScript -->
        <a id="button_wikipedia" type="button" href="https://en.wikipedia.org/wiki/Partita_for_Violin_No._3_(Bach)" target="_blank" rel="noopener noreferrer"
          class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center position-absolute rounded-circle"
          title="Wikipedia: Partita for Violin No. 3 (Bach)" style="visibility: hidden; width: 28px; height: 28px; border: 1px solid gray; right: 0;">
          <img src="media/Wikipedia's_W.svg" width="32" height="32" alt="Wikipedia"
            style="filter: brightness(0) saturate(100%) invert(50%) sepia(5%) saturate(388%) hue-rotate(314deg) brightness(89%) contrast(87%);">
        </a>
      </h2>
      <div class="d-flex align-items-center justify-content-center position-relative">
        <!-- Main audio player -->
        <audio id="audio" class="flex-shrink-1" controls src="audio/bwv1006202505211530.wav"></audio>
      </div>
    </div>
  </div>

  <!-- Loading spinner - hidden after content loads -->
  <div id="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div>Loading score and notes…</div>
  </div>

  <!-- Main content area for musical notation -->
  <div class="container">
    <div id="svg-container"></div>
  </div>

  <footer id="footer" style="z-index: 10; display: flex;"
    class="bg-light footer fixed-bottom mt-auto py-1 d-flex flex-wrap justify-content-evenly shadow-sm border-top">
    <div class="ms-2" style="margin: auto 0;"><!--  background: #57728b40; -->
      <span class="text-muted" style="margin-top: auto; font-size: small;"><span>© 2025 Christophe Thiebaud</span></span>
    </div>
        <!-- Scroll-to-top button - auto-hides when not needed -->
        <a id="button_scroll_to_top" type="button" class="btn btn-outline-secondary mx-2 btn-sm d-inline-flex align-items-center justify-content-center position-absolute"
          style="visibility: hidden; width: 24px; height: 24px; border: 1px solid gray; right: 0;" title="scroll_to_top"
          onclick="document.getElementById('svg-container').scrollIntoView({ behavior: 'smooth', block: 'start'}); return false;">
          <img src="media/up-arrow-svgrepo-com.svg" width="16" height="16" alt="scroll_up"
            style="filter: brightness(0) saturate(100%) invert(50%) sepia(5%) saturate(388%) hue-rotate(314deg) brightness(89%) contrast(87%);">
        </a>
  </footer>

  <script>
    // =============================================================================
    // CONFIGURATION AND CONSTANTS
    // =============================================================================

    // File paths for SVG notation and note timing data
    const svgPath = "bwv1006_svg_no_hrefs_in_tabs_swellable_optimized.svg";
    const notesPath = "bwv1006_json_notes.json";
    const audio = document.getElementById("audio");

    // Musical timing constants for bar calculation
    const TOTAL_DURATION_SECONDS = 207 - 1;
    const TOTAL_BARS = 138;
    const SECONDS_PER_BAR = TOTAL_DURATION_SECONDS / TOTAL_BARS;
    const VISUAL_LEAD_TIME = 0.2; // Visual highlighting lead time in seconds

    // =============================================================================
    // GLOBAL STATE VARIABLES
    // =============================================================================

    // Note data and playback state
    let notes = [], remainingNotes = [], offCandidateNotes = [];
    let svgGlobal, noteDataGlobal, headerElementGlobal, footerElementGlobal;
    let isPlaying = false;
    let currentVisibleBar = -1;

    // UI measurements
    let HEADER_HEIGHT = 120; // fallback value, updated from CSS

    // =============================================================================
    // PLAYBACK STATE MANAGEMENT
    // =============================================================================

    function setPlayingState(isPlayingState) {
      if (!svgGlobal) return;

      if (isPlayingState) {
        svgGlobal.classList.add('playing');
        headerElementGlobal.classList.add('playing');
        footerElementGlobal.classList.add('playing');
      } else {
        svgGlobal.classList.remove('playing');
        headerElementGlobal.classList.remove('playing');
        footerElementGlobal.classList.remove('playing');
        // Clean up visual states when stopping
        svgGlobal.querySelectorAll('a[href^=""].active').forEach(el => el.classList.remove("active"));
        hideAllBars();
        currentVisibleBar = -1;
      }
    }

    // =============================================================================
    // DEBUG UTILITIES
    // =============================================================================

    function debugBar(barNumber) {
      const rect = document.querySelector(`rect[data-bar="${barNumber}"]`);
      if (!rect) return;

      const bbox = rect.getBBox();
      const boundingRect = rect.getBoundingClientRect();

      console.log(`Bar ${barNumber}:`);
      console.log('  getBBox() (SVG coordinates):', {
        x: bbox.x,
        y: bbox.y,
        width: bbox.width,
        height: bbox.height
      });
      console.log('  getBoundingClientRect() (screen coordinates):', {
        x: boundingRect.x,
        y: boundingRect.y,
        top: boundingRect.top,
        left: boundingRect.left,
        width: boundingRect.width,
        height: boundingRect.height
      });
    }

    // =============================================================================
    // UI VISIBILITY MANAGEMENT
    // =============================================================================

    function checkScrollButtonVisibility() {
      if (!footerElementGlobal || !svgGlobal || isPlaying) return;

      const svgRect = svgGlobal.getBoundingClientRect();
      const tolerance = 50;

      // Hide button when SVG is at optimal reading position (just below header)
      const optimalPosition = HEADER_HEIGHT + 20;
      const isAtOptimalPosition = (
        svgRect.top >= (optimalPosition - tolerance) &&
        svgRect.top <= (optimalPosition + tolerance)
      );

      if (isAtOptimalPosition) {
        footerElementGlobal.classList.add('svg-at-top');  
      } else {
        footerElementGlobal.classList.remove('svg-at-top'); 
      }
    }

    // =============================================================================
    // SMART SCROLLING SYSTEM
    // =============================================================================

    function scrollToBar(barNumber) {
      const rects = document.querySelectorAll(`rect[data-bar="${barNumber}"]`);
      if (rects.length === 0) return;

      // Calculate combined bounding box for all bar highlight rectangles
      let minTop = Infinity, maxBottom = -Infinity;
      let minLeft = Infinity, maxRight = -Infinity;

      rects.forEach(rect => {
        const boundingRect = rect.getBoundingClientRect();
        minTop = Math.min(minTop, boundingRect.top);
        maxBottom = Math.max(maxBottom, boundingRect.bottom);
        minLeft = Math.min(minLeft, boundingRect.left);
        maxRight = Math.max(maxRight, boundingRect.right);
      });

      const targetArea = {
        top: minTop,
        bottom: maxBottom,
        left: minLeft,
        right: maxRight,
        height: maxBottom - minTop,
        width: maxRight - minLeft
      };

      // Only scroll if target area isn't fully visible
      const padding = 32;
      const viewportTop = HEADER_HEIGHT + padding;
      const viewportBottom = window.innerHeight;

      const isFullyVisible = (
        targetArea.top >= viewportTop &&
        targetArea.bottom <= viewportBottom
      );

      if (isFullyVisible) {
        // console.log(`Bar ${barNumber} already fully visible, no scroll needed`);
        return;
      }

      // Position target area at top of viewport for forward reading
      const currentScrollY = window.scrollY;
      const targetPageY = targetArea.top + currentScrollY;
      const desiredScrollY = targetPageY - HEADER_HEIGHT - padding;

      window.scrollTo({
        top: desiredScrollY,
        behavior: 'smooth'
      });

      // console.log(`Scrolling to bar ${barNumber}, positioning below header with padding`);
    }

    // =============================================================================
    // MUSICAL TIME AND BAR MANAGEMENT
    // =============================================================================

    function getCurrentBar(currentTime) {
      // Calculate current bar number (1-indexed) from playback time
      const barNumber = Math.floor(currentTime / SECONDS_PER_BAR) + 1;
      return Math.max(1, Math.min(TOTAL_BARS, barNumber));
    }

    function hideAllBars() {
      document.querySelectorAll('rect[data-bar]').forEach(rect => {
        rect.style.visibility = 'hidden';
      });
    }

    function showBar(barNumber) {
      // Show bar highlights and auto-scroll to keep them visible
      scrollToBar(barNumber);
      document.querySelectorAll(`rect[data-bar="${barNumber}"]`).forEach(rect => {
        rect.style.visibility = 'visible';
      });
    }

    // =============================================================================
    // NOTE DATA INITIALIZATION
    // =============================================================================

    function initializeNotes() {
      // Map JSON note data to DOM elements with timing information
      notes = noteDataGlobal.map(n => {
        const elements = n.hrefs.map(href => {
          const selector = `a[href$="${href}"]`;
          return svgGlobal.querySelector(selector);
        }).filter(Boolean);

        // Add channel-specific CSS classes for colored highlighting
        elements.forEach(el => {
          el.classList.add(`channel-${n.channel}`);
        });

        return {
          on: n.on,
          off: n.off,
          elements,
        };
      });

      // console.log(notes)

      remainingNotes = [...notes];
      offCandidateNotes = [];
    }

    // =============================================================================
    // APPLICATION INITIALIZATION
    // =============================================================================

    async function setup() {
      try {
        // Load SVG notation and note timing data in parallel
        const [svgText, noteData] = await Promise.all([
          fetch(svgPath).then(r => {
            if (!r.ok) throw new Error("Failed to load SVG");
                // console.log('Content-Encoding:', r.headers.get('content-encoding'));
                // console.log('Content-Length:', r.headers.get('content-length'));
                return r.text();
          }),
          fetch(notesPath).then(r => {
            if (!r.ok) throw new Error("Failed to load bwv1006_json_notes.json");
            return r.json();
          })
        ]);

        noteDataGlobal = noteData;

        // Initialize DOM references and CSS values
        const svgContainer = document.getElementById("svg-container");
        svgContainer.innerHTML = svgText;
        svgGlobal = svgContainer.querySelector("svg");
        headerElementGlobal = document.getElementById('header');
        footerElementGlobal = document.getElementById('footer');
        HEADER_HEIGHT = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height'));

        if (!svgGlobal) {
          console.error("SVG element not found in loaded content");
          return;
        }

        // Initialize application components
        initializeNotes();
        initEventHandlers();
        hideAllBars(); // Start with all bar highlights hidden

        // console.log(`Loaded ${notes.length} notes`);
        // console.log(`Calculated: ${SECONDS_PER_BAR.toFixed(2)} seconds per bar (${TOTAL_BARS} bars in ${TOTAL_DURATION_SECONDS}s)`);
      } catch (err) {
        console.error("Setup error:", err);
      }

      // Hide loading spinner and initialize UI state
      document.getElementById("loading")?.classList.add("d-none");
      checkScrollButtonVisibility()
    }

    // =============================================================================
    // NOTE HIGHLIGHTING SYSTEM
    // =============================================================================

    function highlightNote(note) {
      note.elements.forEach(el => el.classList.add("active"));
    }

    function unhighlightNote(note) {
      note.elements.forEach(el => el.classList.remove("active"));
    }

    // =============================================================================
    // DYNAMIC BUTTON POSITIONING
    // =============================================================================

    function positionButton() {
      // Position header and footer buttons relative to SVG content for better visual alignment
      const buttons = document.querySelectorAll('#button_wikipedia, #button_scroll_to_top')
      const svgRect = svgGlobal.getBoundingClientRect();
      buttons.forEach(button => {
        button.style.right = `${svgRect.left}px`;
        button.style.zIndex = '1000';
      })
    }

    // =============================================================================
    // PERFORMANCE OPTIMIZATION UTILITIES
    // =============================================================================

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Debounced versions for performance
    const debouncedPositionButton = debounce(positionButton, 50);
    const debouncedCheckScroll = debounce(checkScrollButtonVisibility, 50);

    // =============================================================================
    // REAL-TIME PLAYBACK SYNCHRONIZATION
    // =============================================================================

    function syncLoop() {
      if (!isPlaying) return;

      const now = audio.currentTime;
      const visualTime = now + VISUAL_LEAD_TIME;
      const visualEndTime = visualTime;

      // Activate notes that should be highlighted now
      while (remainingNotes.length && remainingNotes[0].on <= visualTime) {
        const note = remainingNotes.shift();
        highlightNote(note);
        offCandidateNotes.push(note);
      }

      // Deactivate notes that should no longer be highlighted
      offCandidateNotes = offCandidateNotes.filter(note => {
        if (note.off <= visualEndTime) {
          unhighlightNote(note);
          return false;
        }
        return true;
      });

      // Update bar highlighting and auto-scroll
      const currentBar = getCurrentBar(visualTime);
      if (currentBar !== currentVisibleBar) {
        hideAllBars();
        showBar(currentBar);
        currentVisibleBar = currentBar;
        // console.log(`Showing bar ${currentBar} at time ${now.toFixed(2)}s`);
      }

      requestAnimationFrame(syncLoop);
    }

    // =============================================================================
    // PLAYBACK STATE RESET
    // =============================================================================

    function resetAnimationState() {
      isPlaying = false;
      setPlayingState(false);
      audio.currentTime = 0;
      initializeNotes();
      svgGlobal?.querySelectorAll('a[href^=""].active').forEach(el => el.classList.remove("active"));
      hideAllBars();
      currentVisibleBar = -1;
    }

    // =============================================================================
    // APPLICATION STARTUP
    // =============================================================================

    if (audio.readyState >= 1) {
      setup();
    } else {
      audio.addEventListener("loadedmetadata", setup);
    }

    // =============================================================================
    // EVENT HANDLER INITIALIZATION
    // =============================================================================

    function initEventHandlers() {
      // Initialize UI positioning and visibility
      positionButton();
      document.querySelectorAll('#button_wikipedia, #button_scroll_to_top').forEach(button => {
        button.style.visibility = 'visible'
      });

      // Window event listeners with performance optimization
      window.addEventListener('resize', debouncedPositionButton);
      window.addEventListener('scroll', debouncedCheckScroll);

      // Audio playback event handlers
      audio.addEventListener("play", () => {
        isPlaying = true;
        setPlayingState(true);
        requestAnimationFrame(syncLoop);
        // console.log("Playback started.");
      });

      audio.addEventListener("seeked", () => {
        // console.log("seeked");
        const now = audio.currentTime;

        // Recalculate note states based on new playback position
        remainingNotes = notes.filter(note => note.on > now);
        offCandidateNotes = notes.filter(note => note.on <= now && note.off > now);

        // Update visual states
        svgGlobal?.querySelectorAll('a[href^=""].active').forEach(el => el.classList.remove("active"));
        offCandidateNotes.forEach(note => highlightNote(note));

        // Update bar highlighting
        const currentBar = getCurrentBar(now);
        hideAllBars();
        showBar(currentBar);
        currentVisibleBar = currentBar;

        // console.log("seeked to", now.toFixed(3), "→ notes updated, showing bar", currentBar);
      });

      audio.addEventListener("pause", () => {
        isPlaying = false;
        setPlayingState(false);
        // console.log("Playback paused.");
      });

      audio.addEventListener("ended", () => {
        resetAnimationState();
        // console.log("Playback ended.");
      });
    }
  </script>
</body>

</html>