<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>BWV1006 Sync (notes.json-based)</title>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
  <style>
    svg a path {
      transition: fill 0.3s ease, filter 1s ease;
      fill: black;
    }

    svg a.active path {
      fill: orange !important;
      filter: drop-shadow(0 0 5px orange) drop-shadow(0 0 10px orange);
    }
  </style>
</head>

<body>
  <div class="sticky-top bg-light py-2 shadow-sm border-bottom">
    <div class="container text-center">
      <h2>BWV1006 Sync (MIDI-based with Ties)</h2>
      <audio id="audio" controls src="wavs/bwv1006202505191946.wav"></audio>
    </div>
  </div>
  <!-- Centered SVG container -->
  <div class="container my-4">
    <div id="svg-container" class="d-flex justify-content-center"></div>
  </div>

  <script>
    const svgPath = "bwv1006_one_page.svg";
    const notesPath = "notes.json";
    const audio = document.getElementById("audio");

    let notes = [], remainingNotes = [], offCandidateNotes = [];
    let svgGlobal, noteDataGlobal;
    let isPlaying = false;

    function initializeNotes() {
      notes = noteDataGlobal.map(n => {
        const elements = n.hrefs.map(href => {
          const selector = `[*|href$="${href}"], [href$="${href}"]`;
          return svgGlobal.querySelector(selector);
        }).filter(Boolean);

        return {
          on: n.on,
          off: n.off,
          elements,
        };
      });

      remainingNotes = [...notes];
      offCandidateNotes = [];
    }

    async function setup() {
      try {
        initEventHandlers();

        const [svgText, noteData] = await Promise.all([
          fetch(svgPath).then(r => {
            if (!r.ok) throw new Error("Failed to load SVG");
            return r.text();
          }),
          fetch(notesPath).then(r => {
            if (!r.ok) throw new Error("Failed to load notes.json");
            return r.json();
          })
        ]);

        noteDataGlobal = noteData;

        const svgContainer = document.getElementById("svg-container");
        svgContainer.innerHTML = svgText;
        svgGlobal = svgContainer.querySelector("svg");

        if (!svgGlobal) {
          console.error("SVG element not found in loaded content");
          return;
        }

        initializeNotes();
        console.log(`Loaded ${notes.length} notes`);
      } catch (err) {
        console.error("Setup error:", err);
      }
    }

    function highlightNote(note) {
      note.elements.forEach(el => el.classList.add("active"));
    }

    function unhighlightNote(note) {
      note.elements.forEach(el => el.classList.remove("active"));
    }

    function syncLoop() {
      if (!isPlaying) return; // Don't proceed if audio is paused or ended

      const now = audio.currentTime;
      while (remainingNotes.length && remainingNotes[0].on <= now + 0.2) {
        const note = remainingNotes.shift();
        highlightNote(note);
        offCandidateNotes.push(note);
      }

      offCandidateNotes = offCandidateNotes.filter(note => {
        if (note.off <= now) {
          unhighlightNote(note);
          return false;
        }
        return true;
      });

      requestAnimationFrame(syncLoop);
    }

    function resetAnimationState() {
      isPlaying = false;
      audio.currentTime = 0;
      initializeNotes();
      svgGlobal?.querySelectorAll("a.active").forEach(el => el.classList.remove("active"));
    }

    audio.addEventListener("loadedmetadata", setup);

    function initEventHandlers() {

      audio.addEventListener("play", () => {
        // resetAnimationState();
        isPlaying = true;
        requestAnimationFrame(syncLoop);
        console.log("Playback started.");
      });

      audio.addEventListener("seeked", () => {
        console.log("seeked");
        const now = audio.currentTime;

        remainingNotes = notes.filter(note => note.on > now);
        offCandidateNotes = notes.filter(note => note.on <= now && note.off > now);

        svgGlobal?.querySelectorAll("a.active").forEach(el => el.classList.remove("active"));
        offCandidateNotes.forEach(note => highlightNote(note));
        console.log("seeked to", now.toFixed(3), "â†’ notes updated");
      });

      audio.addEventListener("pause", () => {
        isPlaying = false;
        console.log("Playback paused.");
      });

      audio.addEventListener("ended", () => {
        resetAnimationState();
        console.log("Playback ended.");
      });

    }
  </script>
</body>

</html>