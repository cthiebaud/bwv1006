<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BWV1006 Sync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    svg a path {
      transition: fill 0.3s ease, filter 0.3s ease;
      fill: black;
    }

    svg a.active path {
      fill: #ff3333 !important;
      filter: drop-shadow(0 0 5px #ff8888) drop-shadow(0 0 10px #ff4444);
    }

    #top-bar {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 1000;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="top-bar">
    <h2>BWV1006 Sync (MIDI + Ties)</h2>
    <audio id="audio" controls src="bwv1006202505181429.wav"></audio>
  </div>

  <div class="container mt-4">
    <div id="svg-container"></div>
  </div>

  <script>
    const audio = document.getElementById("audio");
    const svgContainer = document.getElementById("svg-container");
    let notes = [];
    let remainingNotes = [];

    async function setup() {
      const [svgText, notesData] = await Promise.all([
        fetch("bwv1006.svg").then(res => res.text()),
        fetch("notes.json").then(res => res.json())
      ]);

      svgContainer.innerHTML = svgText;
      const svg = svgContainer.querySelector("svg");

      const duration = await new Promise(resolve => {
        audio.addEventListener("loadedmetadata", () => resolve(audio.duration));
      });

      notes = notesData.map(n => {
        const elements = n.hrefs.map(href => {
          const sel = `[xlink\:href*="${href}"]`;
          return svg.querySelector(sel);
        }).filter(el => el);

        return {
          on: n.on / notesData[notesData.length - 1].off * duration,
          off: n.off / notesData[notesData.length - 1].off * duration,
          elements
        };
      });

      remainingNotes = [...notes];
    }

    function syncLoop() {
      const now = audio.currentTime;

      while (remainingNotes.length && remainingNotes[0].on <= now) {
        const note = remainingNotes.shift();
        note.elements.forEach(el => el.classList.add("active"));
        setTimeout(() => note.elements.forEach(el => el.classList.remove("active")),
                   (note.off - note.on) * 1000);
      }

      requestAnimationFrame(syncLoop);
    }

    audio.addEventListener("play", () => requestAnimationFrame(syncLoop));
    setup();
  </script>
</body>
</html>
